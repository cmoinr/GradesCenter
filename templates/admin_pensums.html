{% extends "layout.html" %}

{% block title %}
    Admin | Pensums
{% endblock %}

{% block main %}
    <div class="mb-3">
        <h3>Pensums</h3>
        <h6>All subjects</h6>
    </div>
    <div class="mb-3">
        <button class="btn btn-primary" id="new_strategy" type="button" onclick="addStrategies()">Add New Subject</button>
        <form id="add_Strategies" style="display: none;" action="/strategies" method="POST">
            <input type="text" name="subject_id" placeholder="ID" required>
            <br><br>
            <input type="text" name="name" placeholder="Name" required>
            <br><br>
            <select id="faculty_select" name="department">
                <option disabled="" selected="">Department</option>
                <option value="SE70">Systems Engineering</option>
                <option value="ME02">Medicine</option>
                <option value="EC03">Economics</option>
                <option value="DE04">Dentistry</option>
                <option value="AG05">Agronomy</option>
                <option value="SC06">Social Communication</option>
                <option value="PO90">Politics</option>
            </select>
            <br><br>
            <input type="number" name="semester" placeholder="Semester" required>
            <br><br>
            <input type="number" name="credits" placeholder="Credits" required>
            <br><br>
            <input type="number" name="sections" placeholder="Sections" required>
            <br><br>
            <input class="btn" id="strategy_save" type="submit" value="Save">
        </form>

        <table>
            <thead>
                <tr class="high">
                    <th>ID</th>
                    <th>Name <input class="filter" type="text" id="filterName" placeholder="filter"></th>
                    <th>Faculty <input class="filter" type="text" id="filterFaculty" placeholder="filter"></th>
                    <th>Semester</th>
                    <th>Credits</th>
                    <th>Sections</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for subject in subjects %}
                    <tr>
                        <td>{{ subject['id'] }}</td>
                        <td>{{ subject['name'] }}</td>
                        <td>{{ subject['field'] }}</td>
                        <td>{{ subject['semester'] }}</td>
                        <td>{{ subject['credits'] }}</td>
                        <td>{{ subject['sections'] }}</td>
                        <td>                     
                            <button class="btn btn-primary" type="button" onclick="editStrategies(this)">Edit</button>
                            <form id="edit_Strategies" style="display: none;" action="/strategies" method="post">
                                <input id="edit_strategy_form" type="text" name="editing_id" value="{{ subject['id'] }}">
                                <input id="edit_strategy_form" type="text" name="editing_name" value="{{ subject['name'] }}" required>
                                <input id="edit_strategy_form" type="text" name="editing_field" value="{{ subject['field'] }}" required>
                                <input id="edit_strategy_form" type="number" name="editing_semester" value="{{ subject['semester'] }}" min="1" required>
                                <input id="edit_strategy_form" type="number" name="editing_credits" value="{{ subject['credits'] }}" required>
                                <input id="edit_strategy_form" type="number" name="editing_sections" value="{{ subject['sections'] }}" required>
                                <input class="btn" id="strategy_save2" type="submit" value="Save">
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <script>
            function showForm(button) {
                // Obtener el índice de la fila (asumiendo que los botones tienen la misma estructura)
                var rowIndex = button.parentNode.parentNode.rowIndex;
                
                // Obtener el ID del formulario
                var formId = "edit-form-" + rowIndex;

                // Mostrar el formulario
                document.getElementById(formId).style.display = "block";
            }

            function addStrategies() {
                // Obtener todos los porcentajes actuales de la tabla
                const rows = document.querySelectorAll('table tbody tr');
                let totalPercentage = 0;

                rows.forEach(row => {
                    const percentageCell = row.cells[2]; // Índice de la columna de porcentaje
                    const percentageValue = parseFloat(percentageCell.textContent) || 0;
                    totalPercentage += percentageValue;
                });

                // Verificar si la suma de los porcentajes supera el 100
                if (totalPercentage >= 100) {
                    alert("No se pueden agregar más estrategias. La suma de los porcentajes ya alcanza el 100%.");
                    return;
                }

                // Mostrar el formulario si la suma es válida
                document.getElementById("add_Strategies").style.display = "block";
            }

            function editStrategies(button) {
                // Ocultar el botón
                button.style.display = "none";
                
                // Mostrar el formulario
                var form = button.nextElementSibling;
                form.style.display = "block";

                // Asignar validación al formulario de edición
                form.addEventListener("submit", function(event) {
                    if (!validateEditPercentageInput(form)) {
                        event.preventDefault(); // Detener el envío del formulario
                    }
                });
            }
        </script>
    </div>

    <script>
        const filterName = document.getElementById('filterName');
        const filterFaculty = document.getElementById('filterFaculty');
        // ... otros elementos de filtro ...
      
        function filterTable() {
          const rows = document.querySelectorAll('table tbody tr');
          const nameFilter = filterName.value.toLowerCase();
          const facultyFilter = filterFaculty.value.toLowerCase();
      
          rows.forEach(row => {
            const nameCell = row.cells[0]; // Ajusta el índice si la columna de nombre no es la tercera
            const facultyCell = row.cells[1]; // Ajusta el índice si la columna de facultad no es la cuarta
            const nameMatch = nameCell.textContent.toLowerCase().includes(nameFilter);
            const facultyMatch = facultyCell.textContent.toLowerCase().includes(facultyFilter);
      
            row.style.display = nameMatch && facultyMatch ? '' : 'none';
          });
        }
      
        // Asignar event listeners a todos los campos de filtro
        filterName.addEventListener('keyup', filterTable);
        filterFaculty.addEventListener('keyup', filterTable);
        // ... otros event listeners ...
    </script>
{% endblock %}